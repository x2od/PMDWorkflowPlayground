<?xml version="1.0" encoding="UTF-8" ?>
<ruleset
	name="dschach PMD Ruleset"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">
	<description>David Schach default PMD ruleset</description>
	<exclude-pattern>.*/.sfdx/.*</exclude-pattern>
	<exclude-pattern>.*/.sf/.*</exclude-pattern>
	<exclude-pattern>.*/node_modules/.*</exclude-pattern>
	<exclude-pattern>.*/doc.*/.*</exclude-pattern>
	<exclude-pattern>.*__.*</exclude-pattern>
	<exclude-pattern>.*/Admin.profile</exclude-pattern>

	<!-- Custom Objects / Fields Rules -->

	<rule
		name="ModifyOrViewAllData"
		language="xml"
		message="Allowing this user permission can give access and ability to modify sensitive data."
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Profiles and Permission Sets should not have MAD or VAD permission</description>
		<priority>1</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ 
					//(PermissionSet | Profile)/userPermissions[ name/text[@Text='ModifyAllData' or @Text='ViewAllData'] and enabled/text[@Text='true' and pmd:fileName() != 'Admin.profile-meta.xml'] ] 
				]]></value>
			</property>
		</properties>
	</rule>

	<rule
		name="ModifyOrViewAllRecords"
		language="xml"
		message="We strongly recommend using sharing rules to grant record access rather than View All or Modify All."
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Profiles and Permission Sets should not have modify or view all records permission</description>
		<priority>2</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[  //(Profile | PermissionSet)/objectPermissions/(modifyAllRecords | viewAllRecords)/text[matches(@Text, 'true')]  ]]> </value>
			</property>
		</properties>
	</rule>

	<rule name="NonPrivateObjectSharing" language="xml" message="All objects should use Private sharing by default." class="net.sourceforge.pmd.lang.xml.rule.DomXPathRule">
		<description>Require org-wide defaults to be Private for all objects</description>
		<priority>1</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[  //CustomObject/sharingModel/text[@Text='Read' or @Text='ReadWrite']  ]]> </value>
			</property>
		</properties>
	</rule>

	<rule name="MetadataNotDescription2" language="xml" message="Add a description to explain custom metadata" class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Provide a description for custom metadata</description>
		<priority>2</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ //(CustomField | Profile | CustomObject | PermissionSet)[count(description) = 0] ]]></value>
			</property>
		</properties>
	</rule>

	<rule name="MetadataDescription" language="xml" message="Delete the description" class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Delete the description for custom metadata</description>
		<priority>2</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ //(PermissionSet|CustomField)/description ]]></value>
			</property>
		</properties>
	</rule>

	<rule
		name="ManageUsersByNonSysAdmins"
		language="xml"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
		message="Managing users needs to be limited to System Administrator Profile only.">
		<description>This is a restricted permission</description>
		<priority>1</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ //(Profile | PermissionSet)/userPermissions[ pmd:fileName() != 'Admin.profile-meta.xml' and name/text[matches(@Text, 'Manage.*Users')] ] ]]> </value>
			</property>
		</properties>
	</rule>

	<rule
		name="ViewSetupByNonSysAdmins"
		language="xml"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
		message="Viewing Setup should be limited to System Administrator Profile only.">
		<description>This is a restricted permission</description>
		<priority>1</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ //(Profile | PermissionSet)/userPermissions[ pmd:fileName() != 'Admin.profile-meta.xml' and name/text[@Text='ViewSetup'] ] ]]> </value>
			</property>
		</properties>
	</rule>

	<rule name="NoUnderscoresInFieldNames" language="xml" message="Custom fields should not contain underscores." class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Stupid rule to check matches</description>
		<properties>
			<property name="xpath">
				<value><![CDATA[  //CustomField/fullName/text[matches(@Text, '.*_.*__c')]  ]]></value>
			</property>
		</properties>
	</rule>

	<!-- Metadata XML Rules -->

	<rule name="BumpApiVersion" language="xml" message="Metadata should use the latest API version." class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>check API version</description>
		<priority>3</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[ //apiVersion/text[number(@Image) < 50] ]]></value>
			</property>
		</properties>
	</rule>

	<rule name="DoNotUseProcessBuilder" language="xml" message="Convert Process Builders to Flows" class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
		<description>Salesforce is transitioning away from Process Builder in favor of Flow. Migrate automations to Flow.</description>
		<priority>1</priority>
		<properties>
			<property name="xpath">
				<value><![CDATA[  
					Flow/processType/text[@Text='Workflow']
				]]> </value>
			</property>
		</properties>
	</rule>
</ruleset>
